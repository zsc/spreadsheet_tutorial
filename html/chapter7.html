<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第7章：脚本化与自动化编程</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">电子表格与飞书多维表格技术教程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第1章：电子表格的前世今生</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第2章：核心数据模型与计算引擎</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第3章：实时协作的技术基础</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第4章：权限系统与数据安全</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第5章：公式系统的进化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第6章：数据连接与集成</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第7章：脚本化与自动化编程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第8章：可视化与仪表板</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第9章：自然语言处理与智能填充</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第10章：机器学习模型集成</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第11章：智能自动化与工作流</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第12章：性能优化与规模化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第13章：企业级部署架构</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第14章：生产制造企业的数字化转型</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第15章：法律咨询服务的知识管理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第16章：3D AI创业团队的敏捷协作</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第17章：大型房产中介的运营管理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第18章：跨行业通用模式与最佳实践</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第19章：主流协作平台深度对比：飞书、钉钉、腾讯文档+企业微信</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="7">第7章：脚本化与自动化编程</h1>
<h2 id="_1">章节概览</h2>
<p>电子表格的脚本化能力将其从静态的数据容器转变为动态的应用平台。本章深入探讨Google Apps Script的架构设计、事件驱动编程模型、自定义函数实现原理，以及飞书多维表格的脚本能力和低代码平台。我们将从执行环境、安全模型、性能优化等多个维度剖析表格脚本化的技术细节，并提供实践中的最佳模式。</p>
<h2 id="_2">学习目标</h2>
<ul>
<li>理解电子表格脚本执行环境的架构设计</li>
<li>掌握事件驱动模型与触发器的工作原理</li>
<li>学习自定义函数与宏的实现机制</li>
<li>了解飞书多维表格的脚本能力与低代码设计理念</li>
<li>掌握安全沙箱的隔离机制与权限控制</li>
<li>熟悉调试工具链与性能分析方法</li>
</ul>
<h2 id="71-google-apps-script">7.1 Google Apps Script架构剖析</h2>
<h3 id="711">7.1.1 执行环境架构</h3>
<p>Google Apps Script (GAS) 基于 Rhino JavaScript 引擎（后迁移到 V8），提供了一个云端的 JavaScript 运行时环境。其架构设计有几个关键特点：</p>
<p><strong>分层架构模型</strong></p>
<div class="codehilite"><pre><span></span><code>┌─────────────────────────────────────┐
│         用户脚本代码                │
├─────────────────────────────────────┤
│      Apps Script API 层             │
│   (SpreadsheetApp, DriveApp等)      │
├─────────────────────────────────────┤
│        执行运行时 (V8)              │
├─────────────────────────────────────┤
│      安全沙箱与权限管理             │
├─────────────────────────────────────┤
│     Google Cloud Platform           │
└─────────────────────────────────────┘
</code></pre></div>

<p><strong>执行模型特点</strong>：</p>
<ol>
<li><strong>无状态执行</strong>：每次脚本执行都在独立的上下文中运行，执行完成后上下文销毁</li>
<li><strong>执行时限</strong>：单次执行最长6分钟（简单触发器30秒）</li>
<li><strong>配额限制</strong>：API调用次数、执行时间总量都有日配额限制</li>
<li><strong>异步支持</strong>：通过 UrlFetchApp 支持异步 HTTP 请求，但整体仍是同步执行模型</li>
</ol>
<h3 id="712-api">7.1.2 API设计哲学</h3>
<p>GAS 的 API 设计遵循"领域对象模型"（Domain Object Model）原则：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 典型的链式调用模式</span>
<span class="nx">SpreadsheetApp</span>
<span class="w">  </span><span class="p">.</span><span class="nx">getActiveSpreadsheet</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s2">&quot;数据&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s2">&quot;A1:C10&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</code></pre></div>

<p>这种设计的优势：</p>
<ul>
<li><strong>直观性</strong>：API 结构映射实际的表格层次结构</li>
<li><strong>类型安全</strong>：每个方法返回特定类型的对象</li>
<li><strong>可发现性</strong>：IDE 可以提供良好的自动补全</li>
</ul>
<h3 id="713">7.1.3 服务集成架构</h3>
<p>GAS 最强大的特性是与 Google Workspace 的深度集成：</p>
<div class="codehilite"><pre><span></span><code>┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Sheets     │────▶│  Apps Script │────▶│    Drive     │
└──────────────┘     └──────────────┘     └──────────────┘
                             │
                             ▼
                     ┌──────────────┐
                     │    Gmail     │
                     └──────────────┘
</code></pre></div>

<p><strong>集成要点</strong>：</p>
<ul>
<li><strong>统一认证</strong>：使用 OAuth 2.0，用户授权一次即可访问多个服务</li>
<li><strong>数据流转</strong>：可以在不同服务间无缝传递数据</li>
<li><strong>事件联动</strong>：一个服务的事件可以触发对其他服务的操作</li>
</ul>
<h2 id="72">7.2 事件驱动模型与触发器机制</h2>
<h3 id="721">7.2.1 触发器类型与特性</h3>
<p>GAS 支持多种触发器类型，每种都有其特定的使用场景和限制：</p>
<ol>
<li><strong>简单触发器（Simple Triggers）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// onOpen - 表格打开时触发</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onOpen</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getUi</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">createMenu</span><span class="p">(</span><span class="s1">&#39;自定义菜单&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">addItem</span><span class="p">(</span><span class="s1">&#39;执行分析&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;runAnalysis&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">addToUi</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// onEdit - 单元格编辑时触发</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onEdit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// 记录编辑历史</span>
<span class="w">  </span><span class="nx">logEdit</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">getA1Notation</span><span class="p">(),</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>特点：</p>
<ul>
<li>自动触发，无需安装</li>
<li>权限受限（不能访问需要授权的服务）</li>
<li>执行时限30秒</li>
<li>不能执行需要用户交互的操作</li>
</ul>
<ol start="2">
<li><strong>可安装触发器（Installable Triggers）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 时间驱动触发器</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">setupTimeTrigger</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s1">&#39;processData&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">everyHours</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 表单提交触发器</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onFormSubmit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">values</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processFormData</span><span class="p">(</span><span class="nx">responses</span><span class="p">);</span>
<span class="w">  </span><span class="nx">sendNotification</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>优势：</p>
<ul>
<li>可以访问需要授权的服务</li>
<li>执行时限6分钟</li>
<li>支持更多事件类型</li>
<li>可以以脚本所有者身份运行</li>
</ul>
<h3 id="722">7.2.2 事件对象结构</h3>
<p>触发器接收的事件对象包含丰富的上下文信息：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// onEdit 事件对象示例</span>
<span class="p">{</span>
<span class="w">  </span><span class="nx">authMode</span><span class="o">:</span><span class="w"> </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">AuthMode</span><span class="p">.</span><span class="nx">LIMITED</span><span class="p">,</span>
<span class="w">  </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="nx">Range</span><span class="p">,</span><span class="w">           </span><span class="c1">// 被编辑的范围</span>
<span class="w">  </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="nx">Spreadsheet</span><span class="p">,</span><span class="w">    </span><span class="c1">// 源表格</span>
<span class="w">  </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">User</span><span class="p">,</span><span class="w">            </span><span class="c1">// 执行用户</span>
<span class="w">  </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="p">,</span><span class="w">         </span><span class="c1">// 新值</span>
<span class="w">  </span><span class="nx">oldValue</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="w">       </span><span class="c1">// 旧值（仅可安装触发器）</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="723">7.2.3 触发器链与级联效应</h3>
<p>在复杂应用中，触发器可能形成链式反应：</p>
<div class="codehilite"><pre><span></span><code>用户编辑 → onEdit触发器 → 更新其他单元格 → 公式重算 → onChange触发器
    ↓
发送通知 ← 记录日志 ← 数据验证
</code></pre></div>

<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>防止循环触发</strong>：使用标志位或时间戳避免无限循环</li>
<li><strong>批量处理</strong>：累积多个变更后统一处理</li>
<li><strong>错误隔离</strong>：使用 try-catch 确保单个错误不影响整体流程</li>
</ol>
<h2 id="73">7.3 自定义函数与宏的实现原理</h2>
<h3 id="731">7.3.1 自定义函数机制</h3>
<p>自定义函数允许用户扩展表格的公式能力：</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>

<span class="cm"> * 计算加权平均值</span>
<span class="cm"> * @param {range} values 数值范围</span>
<span class="cm"> * @param {range} weights 权重范围</span>
<span class="cm"> * @return {number} 加权平均值</span>
<span class="cm"> * @customfunction</span>
<span class="cm"> */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">WEIGHTED_AVG</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span><span class="w"> </span><span class="nx">weights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">weights</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;数值和权重数量不匹配&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">weightSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">weights</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">    </span><span class="nx">weightSum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">weights</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">weightSum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>执行特性</strong>：</p>
<ul>
<li><strong>自动重算</strong>：当依赖的单元格变化时自动重新执行</li>
<li><strong>缓存机制</strong>：相同输入会返回缓存结果</li>
<li><strong>限制</strong>：不能修改表格，只能返回值</li>
<li><strong>并行执行</strong>：多个自定义函数可以并行计算</li>
</ul>
<h3 id="732">7.3.2 宏的录制与回放</h3>
<p>宏通过录制用户操作生成脚本代码：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 录制的宏示例</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">Macro1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">spreadsheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActive</span><span class="p">();</span>
<span class="w">  </span><span class="nx">spreadsheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">activate</span><span class="p">();</span>
<span class="w">  </span><span class="nx">spreadsheet</span><span class="p">.</span><span class="nx">getCurrentCell</span><span class="p">().</span><span class="nx">setValue</span><span class="p">(</span><span class="s1">&#39;开始&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">spreadsheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A2:A10&#39;</span><span class="p">).</span><span class="nx">activate</span><span class="p">();</span>
<span class="w">  </span><span class="nx">spreadsheet</span><span class="p">.</span><span class="nx">getActiveRange</span><span class="p">().</span><span class="nx">setBackground</span><span class="p">(</span><span class="s1">&#39;#ffff00&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>宏执行流程</strong>：</p>
<div class="codehilite"><pre><span></span><code>录制开始 → 捕获UI操作 → 转换为API调用 → 生成脚本代码 → 存储
    ↓
执行宏 → 加载脚本 → 顺序执行API调用 → 更新UI
</code></pre></div>

<h3 id="733">7.3.3 性能优化策略</h3>
<p>批量操作优化：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 低效方式 - 多次API调用</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 高效方式 - 批量操作</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
</code></pre></div>

<h2 id="74">7.4 飞书多维表格的脚本能力与低代码平台</h2>
<h3 id="741">7.4.1 脚本执行环境</h3>
<p>飞书多维表格采用了不同于 GAS 的设计理念，更强调低代码和可视化配置：</p>
<div class="codehilite"><pre><span></span><code>┌─────────────────────────────────────┐
│        可视化配置界面               │
│    (自动化规则、按钮、表单)         │
├─────────────────────────────────────┤
│         脚本执行引擎                │
│      (JavaScript 沙箱)              │
├─────────────────────────────────────┤
│      飞书开放平台 API               │
├─────────────────────────────────────┤
│       数据存储与同步                │
└─────────────────────────────────────┘
</code></pre></div>

<h3 id="742">7.4.2 自动化规则系统</h3>
<p>飞书的自动化规则采用"条件-动作"模式：</p>
<div class="codehilite"><pre><span></span><code>触发条件：

  - 记录创建/更新/删除
  - 字段值满足条件
  - 定时触发
  - 按钮点击
    ↓
执行动作：

  - 更新字段值
  - 发送通知
  - 创建关联记录
  - 调用外部API
</code></pre></div>

<p><strong>规则配置示例</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;trigger&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;record_updated&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;conditions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;状态&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;operator&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;equals&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;已完成&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;actions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;update_field&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;完成时间&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{NOW()}}&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;send_notification&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;recipient&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{创建者}}&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;任务已完成&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="743">7.4.3 低代码设计理念</h3>
<p>飞书多维表格的低代码平台特点：</p>
<ol>
<li>
<p><strong>可视化流程编排</strong>
   - 拖拽式流程设计
   - 实时预览执行效果
   - 图形化调试界面</p>
</li>
<li>
<p><strong>预置组件库</strong>
   - 丰富的UI组件
   - 常用业务逻辑模板
   - 第三方服务连接器</p>
</li>
<li>
<p><strong>渐进式复杂度</strong>
   - 简单场景无需代码
   - 复杂逻辑支持脚本
   - 可导出为独立应用</p>
</li>
</ol>
<h3 id="744">7.4.4 与飞书生态的集成</h3>
<div class="codehilite"><pre><span></span><code>多维表格 ←→ 飞书文档
    ↓         ↓
飞书机器人 ← 审批流程
    ↓         ↓
  消息通知   OKR系统
</code></pre></div>

<p>集成能力：</p>
<ul>
<li><strong>数据联动</strong>：表格数据可直接在文档中引用</li>
<li><strong>流程自动化</strong>：与审批、OKR等业务流程打通</li>
<li><strong>智能助手</strong>：通过机器人实现自然语言交互</li>
</ul>
<h2 id="75">7.5 安全沙箱与执行限制</h2>
<h3 id="751">7.5.1 沙箱隔离机制</h3>
<p>脚本执行环境的安全隔离是关键：</p>
<div class="codehilite"><pre><span></span><code>┌─────────────────────────────────────┐
│          用户脚本代码               │
├─────────────────────────────────────┤
│    受限JavaScript环境               │
│  - 无DOM访问                        │
│  - 无文件系统访问                   │
│  - 网络请求需授权                   │
├─────────────────────────────────────┤
│      资源限制层                     │
│  - CPU时间限制                      │
│  - 内存使用限制                     │
│  - API调用配额                      │
├─────────────────────────────────────┤
│      宿主环境                       │
└─────────────────────────────────────┘
</code></pre></div>

<h3 id="752">7.5.2 权限模型</h3>
<p>细粒度的权限控制：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 权限声明示例</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;oauthScopes&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;https://www.googleapis.com/auth/spreadsheets&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://www.googleapis.com/auth/drive.readonly&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://www.googleapis.com/auth/gmail.send&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;urlFetchWhitelist&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;https://api.example.com/*&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>权限级别</strong>：</p>
<ol>
<li><strong>只读权限</strong>：仅能读取数据</li>
<li><strong>当前文档权限</strong>：可修改当前表格</li>
<li><strong>完全权限</strong>：可访问用户的所有文档</li>
</ol>
<h3 id="753">7.5.3 执行限制与配额</h3>
<p>典型的执行限制：</p>
<p>| 限制项 | Google Apps Script | 飞书多维表格 |</p>
<table>
<thead>
<tr>
<th>限制项</th>
<th>Google Apps Script</th>
<th>飞书多维表格</th>
</tr>
</thead>
<tbody>
<tr>
<td>单次执行时间</td>
<td>6分钟</td>
<td>60秒</td>
</tr>
<tr>
<td>日执行时间总量</td>
<td>6小时</td>
<td>2小时</td>
</tr>
<tr>
<td>API调用次数/天</td>
<td>20,000</td>
<td>10,000</td>
</tr>
<tr>
<td>并发执行数</td>
<td>30</td>
<td>20</td>
</tr>
<tr>
<td>脚本大小</td>
<td>1MB</td>
<td>500KB</td>
</tr>
</tbody>
</table>
<h3 id="754">7.5.4 安全最佳实践</h3>
<ol>
<li><strong>输入验证</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">processUserInput</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 始终验证和清理用户输入</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 防止注入攻击</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sanitized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&lt;&gt;]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">sanitized</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>敏感信息处理</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 使用脚本属性存储敏感信息</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PropertiesService</span><span class="p">.</span><span class="nx">getScriptProperties</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;API_KEY&#39;</span><span class="p">);</span>

<span class="c1">// 避免在日志中暴露敏感信息</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Processing user: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">maskEmail</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">));</span>
</code></pre></div>

<ol start="3">
<li><strong>错误处理</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">robustExecution</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 主要逻辑</span>
<span class="w">    </span><span class="nx">performOperation</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 记录错误但不暴露内部细节</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Operation failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 向用户返回友好错误信息</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;操作失败，请稍后重试&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="76">7.6 调试工具与性能分析</h2>
<h3 id="761">7.6.1 调试工具链</h3>
<ol>
<li><strong>日志系统</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 不同级别的日志</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;信息日志&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;警告信息&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;错误信息&#39;</span><span class="p">);</span>

<span class="c1">// 结构化日志</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;processData&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="nx">executionTime</span><span class="p">,</span>
<span class="w">  </span><span class="nx">recordsProcessed</span><span class="o">:</span><span class="w"> </span><span class="nx">count</span>
<span class="p">});</span>
</code></pre></div>

<ol start="2">
<li><strong>断点调试</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">complexCalculation</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">debugger</span><span class="p">;</span><span class="w">  </span><span class="c1">// 在支持的环境中设置断点</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 步进执行，检查变量值</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculate</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>执行记录追踪</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="err">执行</span><span class="n">ID</span><span class="o">:</span><span class="w"> </span><span class="n">abc123</span>
<span class="err">开始时间</span><span class="o">:</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span>
<span class="err">触发器类型</span><span class="o">:</span><span class="w"> </span><span class="n">onEdit</span>
<span class="err">用户</span><span class="o">:</span><span class="w"> </span><span class="n">user</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span>

<span class="o">[</span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mf">00.100</span><span class="o">]</span><span class="w"> </span><span class="err">开始执行</span>
<span class="o">[</span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mf">00.150</span><span class="o">]</span><span class="w"> </span><span class="err">验证权限</span>
<span class="o">[</span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mf">00.200</span><span class="o">]</span><span class="w"> </span><span class="err">读取数据范围</span><span class="w"> </span><span class="n">A1</span><span class="o">:</span><span class="n">C100</span>
<span class="o">[</span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mf">00.500</span><span class="o">]</span><span class="w"> </span><span class="err">处理数据</span>
<span class="o">[</span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mf">01.000</span><span class="o">]</span><span class="w"> </span><span class="err">写入结果</span>
<span class="o">[</span><span class="mi">10</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mf">01.100</span><span class="o">]</span><span class="w"> </span><span class="err">执行完成</span>

<span class="err">总耗时</span><span class="o">:</span><span class="w"> </span><span class="mi">1000</span><span class="n">ms</span>
<span class="n">API调用</span><span class="o">:</span><span class="w"> </span><span class="mi">5</span><span class="err">次</span>
</code></pre></div>

<h3 id="762">7.6.2 性能分析方法</h3>
<ol>
<li><strong>执行时间分析</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">performanceAnalysis</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">profiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Profiler</span><span class="p">();</span>

<span class="w">  </span><span class="nx">profiler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;dataFetch&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fetchData</span><span class="p">();</span>
<span class="w">  </span><span class="nx">profiler</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;dataFetch&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="nx">profiler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">processData</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="nx">profiler</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="nx">profiler</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;writing&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">writeResults</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="w">  </span><span class="nx">profiler</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;writing&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">profiler</span><span class="p">.</span><span class="nx">getReport</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Profiler</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">timings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">start</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">timings</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">end</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">timings</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">timings</span><span class="p">[</span><span class="nx">label</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">timings</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>内存使用监控</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">memoryMonitor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getMemoryUsage</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 执行操作</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">largeData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateLargeDataset</span><span class="p">();</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">peak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getMemoryUsage</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`内存增长: </span><span class="si">${</span><span class="nx">peak</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">baseline</span><span class="si">}</span><span class="sb"> bytes`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 清理</span>
<span class="w">  </span><span class="nx">largeData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="nx">Utilities</span><span class="p">.</span><span class="nx">sleep</span><span class="p">(</span><span class="mf">100</span><span class="p">);</span><span class="w">  </span><span class="c1">// 等待GC</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getMemoryUsage</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`内存释放: </span><span class="si">${</span><span class="nx">peak</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">after</span><span class="si">}</span><span class="sb"> bytes`</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="763">7.6.3 性能优化技巧</h3>
<ol>
<li><strong>缓存策略</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 使用缓存减少重复计算</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">CacheService</span><span class="p">.</span><span class="nx">getScriptCache</span><span class="p">();</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">expensiveOperation</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 检查缓存</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cached</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">cached</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 执行计算</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performCalculation</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 存入缓存（TTL: 600秒）</span>
<span class="w">  </span><span class="nx">cache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span><span class="w"> </span><span class="mf">600</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>批量操作优化</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 低效：逐个单元格操作</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">inefficientUpdate</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="o">+</span><span class="mf">1</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 高效：批量更新</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">efficientUpdate</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
<span class="w">  </span><span class="nx">range</span><span class="p">.</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>异步并发处理</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">parallelProcessing</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 并发发起请求</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">urls</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">url</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">muteHttpExceptions</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="c1">// 批量获取响应</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetchAll</span><span class="p">(</span><span class="nx">requests</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 处理结果</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">responses</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">getContentText</span><span class="p">())</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="764">7.6.4 常见性能陷阱</h3>
<ol>
<li>
<p><strong>过度的API调用</strong>
   - 问题：循环中重复调用 getRange()
   - 解决：预先获取范围，批量操作</p>
</li>
<li>
<p><strong>大数据集处理</strong>
   - 问题：一次性加载过多数据
   - 解决：分页处理，流式处理</p>
</li>
<li>
<p><strong>同步阻塞操作</strong>
   - 问题：串行处理多个独立任务
   - 解决：使用 fetchAll() 等并发API</p>
</li>
<li>
<p><strong>内存泄漏</strong>
   - 问题：闭包持有大对象引用
   - 解决：及时清理，避免全局变量</p>
</li>
</ol>
<h2 id="_3">本章小结</h2>
<p>本章深入探讨了电子表格的脚本化与自动化编程能力，从Google Apps Script的架构设计到飞书多维表格的低代码平台，涵盖了以下核心概念：</p>
<ol>
<li><strong>架构设计</strong>：理解了GAS的分层架构、API设计哲学和服务集成模式</li>
<li><strong>事件模型</strong>：掌握了触发器机制、事件对象结构和级联效应处理</li>
<li><strong>扩展机制</strong>：学习了自定义函数和宏的实现原理及优化策略</li>
<li><strong>平台对比</strong>：对比了GAS与飞书的不同设计理念和实现方式</li>
<li><strong>安全机制</strong>：理解了沙箱隔离、权限控制和执行限制</li>
<li><strong>调试优化</strong>：掌握了调试工具使用和性能优化方法</li>
</ol>
<p><strong>关键洞察</strong>：</p>
<ul>
<li>脚本化将表格从数据容器升级为应用平台</li>
<li>低代码降低了自动化的门槛但不应牺牲灵活性</li>
<li>安全和性能是脚本化系统的两大挑战</li>
<li>生态集成能力决定了平台的应用广度</li>
</ul>
<h2 id="_4">练习题</h2>
<h3 id="_5">基础题</h3>
<p><strong>练习7.1：触发器选择</strong>
某公司需要在每天凌晨2点自动汇总前一天的销售数据并发送邮件报告。请问应该使用哪种类型的触发器？说明原因。</p>
<details>
<summary>提示</summary>
<p>考虑触发器的权限要求和执行时限</p>
</details>
<details>
<summary>答案</summary>
<p>应使用可安装的时间驱动触发器（Installable Time-driven Trigger）。</p>
<p>原因：</p>
<ol>
<li>需要定时执行（每天凌晨2点）</li>
<li>需要发送邮件（需要Gmail服务授权）</li>
<li>可能需要较长执行时间（数据汇总）</li>
<li>简单触发器不支持时间驱动且无法访问需授权的服务</li>
</ol>
<p>实现代码框架：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">installDailyTrigger</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s1">&#39;dailySalesReport&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">atHour</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">everyDays</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">dailySalesReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 汇总数据</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">aggregateSalesData</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// 生成报告</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateReport</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 发送邮件</span>
<span class="w">  </span><span class="nx">sendEmailReport</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>
<p><strong>练习7.2：性能优化</strong>
以下代码用于更新1000行数据的状态列，请识别性能问题并提供优化方案。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">updateStatus</span><span class="p">(</span><span class="nx">sheet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1001</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="s2">&quot;高&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">).</span><span class="nx">setBackground</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="s2">&quot;低&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">).</span><span class="nx">setBackground</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>提示</summary>
<p>考虑批量操作和减少API调用次数</p>
</details>
<details>
<summary>答案</summary>
<p>性能问题：</p>
<ol>
<li>循环中多次调用 getRange() 和 getValue()</li>
<li>逐个单元格设置值和背景色</li>
<li>总共约4000次API调用</li>
</ol>
<p>优化方案：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">updateStatusOptimized</span><span class="p">(</span><span class="nx">sheet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 一次性读取所有数据</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">getValues</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 准备输出数组</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">// 批量处理</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">statuses</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;高&quot;</span><span class="p">]);</span>
<span class="w">      </span><span class="nx">colors</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">statuses</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;低&quot;</span><span class="p">]);</span>
<span class="w">      </span><span class="nx">colors</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;green&quot;</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 批量写入</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">statuses</span><span class="p">);</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">setBackgrounds</span><span class="p">(</span><span class="nx">colors</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>性能提升：从4000次API调用减少到4次，执行速度提升约100倍。</p>
</details>
<p><strong>练习7.3：权限设计</strong>
设计一个脚本的权限配置，该脚本需要：</p>
<ol>
<li>读取当前表格数据</li>
<li>向外部API发送数据</li>
<li>在用户的云盘中创建备份文件</li>
<li>不需要访问用户的邮件</li>
</ol>
<details>
<summary>提示</summary>
<p>考虑最小权限原则</p>
</details>
<details>
<summary>答案</summary>
<p>权限配置：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;oauthScopes&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;https://www.googleapis.com/auth/spreadsheets.currentonly&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://www.googleapis.com/auth/drive.file&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://www.googleapis.com/auth/script.external_request&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;urlFetchWhitelist&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;https://api.company.com/*&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>说明：</p>
<ol>
<li><code>spreadsheets.currentonly</code>：仅访问当前表格</li>
<li><code>drive.file</code>：仅访问脚本创建的文件</li>
<li><code>script.external_request</code>：允许外部HTTP请求</li>
<li>URL白名单限制只能访问特定API</li>
</ol>
<p>这遵循了最小权限原则，避免了不必要的权限（如访问所有表格或邮件）。</p>
</details>
<h3 id="_6">挑战题</h3>
<p><strong>练习7.4：设计事件驱动的库存管理系统</strong>
设计一个基于触发器的库存管理系统，要求：</p>
<ol>
<li>当库存低于安全库存时自动创建采购单</li>
<li>每日生成库存报表</li>
<li>支持多仓库数据同步</li>
<li>提供库存预警通知</li>
</ol>
<p>请设计系统架构和主要触发器逻辑。</p>
<details>
<summary>提示</summary>
<p>考虑不同类型触发器的组合使用和数据一致性</p>
</details>
<details>
<summary>答案</summary>
<p>系统架构设计：</p>
<div class="codehilite"><pre><span></span><code>┌─────────────────────────────────────┐
│         库存主表                     │
│  (产品ID, 名称, 当前库存, 安全库存)  │
└─────────────────────────────────────┘
            ↓ onEdit触发器
┌─────────────────────────────────────┐
│      库存监控脚本                    │
│  - 检查安全库存                      │
│  - 生成采购建议                      │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│       采购单表                       │
│  (自动生成的采购申请)                │
└─────────────────────────────────────┘

时间触发器：

- 每日报表生成
- 多仓库同步
</code></pre></div>

<p>主要触发器实现：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 1. 库存变更触发器</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onInventoryChange</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">range</span><span class="p">.</span><span class="nx">getSheet</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;库存表&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">range</span><span class="p">.</span><span class="nx">getRow</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentStock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">safetyStock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentStock</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">safetyStock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">createPurchaseOrder</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
<span class="w">    </span><span class="nx">sendLowStockAlert</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 2. 定时报表触发器</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">dailyInventoryReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateInventoryReport</span><span class="p">();</span>
<span class="w">  </span><span class="nx">saveReportToDrive</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
<span class="w">  </span><span class="nx">emailReportToManagers</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 3. 多仓库同步触发器</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">syncWarehouses</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">warehouses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;仓库A&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;仓库B&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;仓库C&quot;</span><span class="p">];</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">consolidated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">  </span><span class="nx">warehouses</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">warehouse</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fetchWarehouseData</span><span class="p">(</span><span class="nx">warehouse</span><span class="p">);</span>
<span class="w">    </span><span class="nx">mergeInventoryData</span><span class="p">(</span><span class="nx">consolidated</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">updateMasterInventory</span><span class="p">(</span><span class="nx">consolidated</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 4. 触发器安装</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">setupTriggers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 编辑触发器</span>
<span class="w">  </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s1">&#39;onInventoryChange&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">forSpreadsheet</span><span class="p">(</span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActive</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="nx">onEdit</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 每日报表</span>
<span class="w">  </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s1">&#39;dailyInventoryReport&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">atHour</span><span class="p">(</span><span class="mf">8</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">everyDays</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 仓库同步（每小时）</span>
<span class="w">  </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s1">&#39;syncWarehouses&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">everyHours</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>数据一致性保证：</p>
<ol>
<li>使用事务性更新</li>
<li>加锁机制防止并发冲突</li>
<li>异常重试机制</li>
<li>审计日志记录所有变更</li>
</ol>
</details>
<p><strong>练习7.5：实现自定义函数缓存系统</strong>
实现一个通用的自定义函数缓存系统，要求：</p>
<ol>
<li>支持设置缓存过期时间</li>
<li>支持不同的缓存键生成策略</li>
<li>提供缓存命中率统计</li>
<li>支持手动清理缓存</li>
</ol>
<details>
<summary>提示</summary>
<p>考虑使用CacheService和自定义的缓存管理逻辑</p>
</details>
<details>
<summary>答案</summary>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>

<span class="cm"> * 通用缓存系统实现</span>
<span class="cm"> */</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">FunctionCache</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">CacheService</span><span class="p">.</span><span class="nx">getScriptCache</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">namespace</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hits</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">misses</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sets</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 生成缓存键</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">generateKey</span><span class="p">(</span><span class="nx">functionName</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;json&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">namespace</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">functionName</span><span class="si">}</span><span class="sb">:`</span><span class="p">;</span>

<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="nx">strategy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;json&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;hash&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hashCode</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;custom&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 缓存装饰器</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">memoize</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">ttl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">600</span><span class="p">,</span><span class="w">  </span><span class="c1">// 默认10分钟</span>
<span class="w">      </span><span class="nx">keyStrategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;json&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">shouldCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">function</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 检查是否应该缓存</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">shouldCache</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">generateKey</span><span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">keyStrategy</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 尝试从缓存获取</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cached</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">cache</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">hits</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">cached</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 执行函数</span>
<span class="w">      </span><span class="nx">cache</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">misses</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 存入缓存</span>
<span class="w">      </span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">ttl</span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 获取缓存值</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 设置缓存值</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ttl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">sets</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">serialized</span><span class="p">,</span><span class="w"> </span><span class="nx">ttl</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 清理缓存</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">clear</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">pattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 清理所有（通过设置空值）</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">removeAll</span><span class="p">([]);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 不支持模式匹配，需要追踪所有键</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Pattern-based clearing not supported&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 获取统计信息</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">hits</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">misses</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">stats</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hitRate</span><span class="o">:</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">hits</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="nx">total</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 哈希函数</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">hashCode</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="kr">char</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">      </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">hash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">hash</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kr">char</span><span class="p">;</span>
<span class="w">      </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">hash</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">hash</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 使用示例</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FunctionCache</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">);</span>

<span class="c1">// 原始函数</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">expensiveCalculation</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 模拟耗时计算</span>
<span class="w">  </span><span class="nx">Utilities</span><span class="p">.</span><span class="nx">sleep</span><span class="p">(</span><span class="mf">1000</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 包装为缓存版本</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cachedCalculation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="nx">expensiveCalculation</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ttl</span><span class="o">:</span><span class="w"> </span><span class="mf">300</span><span class="p">,</span><span class="w">  </span><span class="c1">// 5分钟缓存</span>
<span class="w">  </span><span class="nx">keyStrategy</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;custom&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">shouldCache</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w">  </span><span class="c1">// 只缓存正数</span>
<span class="p">});</span>

<span class="c1">// 自定义函数中使用</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">CACHED_CALC</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cachedCalculation</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 查看统计</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">logCacheStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">getStats</span><span class="p">());</span>
<span class="w">  </span><span class="c1">// 输出: {hits: 10, misses: 5, sets: 5, hitRate: 0.67, total: 15}</span>
<span class="p">}</span>
</code></pre></div>

<p>这个缓存系统提供了：</p>
<ol>
<li>灵活的缓存键生成策略</li>
<li>可配置的过期时间</li>
<li>条件缓存（shouldCache）</li>
<li>统计信息收集</li>
<li>装饰器模式便于使用</li>
</ol>
</details>
<p><strong>练习7.6：设计跨表格数据同步方案</strong>
设计一个方案，实现多个表格之间的双向数据同步，要求：</p>
<ol>
<li>支持冲突检测和解决</li>
<li>保证最终一致性</li>
<li>提供同步状态监控</li>
<li>支持选择性同步（只同步特定列或行）</li>
</ol>
<details>
<summary>提示</summary>
<p>考虑使用版本向量、时间戳和冲突解决策略</p>
</details>
<details>
<summary>答案</summary>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>

<span class="cm"> * 跨表格双向同步系统</span>
<span class="cm"> */</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">CrossSheetSync</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">sheets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">sheets</span><span class="p">;</span><span class="w">  </span><span class="c1">// [{id, name, range}]</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">syncColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">columns</span><span class="p">;</span><span class="w">  </span><span class="c1">// 要同步的列</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">conflictStrategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">conflictStrategy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;last-write-wins&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">syncLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 主同步流程</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">performSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">syncId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Utilities</span><span class="p">.</span><span class="nx">getUuid</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`开始同步: </span><span class="si">${</span><span class="nx">syncId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 1. 收集所有表格的当前状态</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">snapshots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">collectSnapshots</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// 2. 检测变更</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">changes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">(</span><span class="nx">snapshots</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 3. 检测冲突</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">conflicts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">detectConflicts</span><span class="p">(</span><span class="nx">changes</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 4. 解决冲突</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">resolved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">resolveConflicts</span><span class="p">(</span><span class="nx">conflicts</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 5. 应用变更</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">applyChanges</span><span class="p">(</span><span class="nx">resolved</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 6. 更新元数据</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">updateMetadata</span><span class="p">(</span><span class="nx">syncId</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 7. 记录日志</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">logSync</span><span class="p">(</span><span class="nx">syncId</span><span class="p">,</span><span class="w"> </span><span class="nx">resolved</span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">syncId</span><span class="o">:</span><span class="w"> </span><span class="nx">syncId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">changesApplied</span><span class="o">:</span><span class="w"> </span><span class="nx">resolved</span><span class="p">.</span><span class="nx">length</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`同步失败: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="nx">syncId</span><span class="p">);</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 收集数据快照</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">collectSnapshots</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">sheets</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">sheet</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">openById</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ss</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ws</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">range</span><span class="p">).</span><span class="nx">getValues</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// 获取元数据（时间戳、版本等）</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getMetadata</span><span class="p">(</span><span class="nx">ws</span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sheetId</span><span class="o">:</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span>
<span class="w">        </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="nx">metadata</span><span class="p">,</span>
<span class="w">        </span><span class="nx">checksum</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateChecksum</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 检测变更</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">detectChanges</span><span class="p">(</span><span class="nx">snapshots</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">changes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="nx">snapshots</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">snapshot</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">lastSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getLastSyncState</span><span class="p">(</span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">sheetId</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">lastSync</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">lastSync</span><span class="p">.</span><span class="nx">checksum</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">checksum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 逐行比较找出具体变更</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rowChanges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">compareRows</span><span class="p">(</span>
<span class="w">          </span><span class="nx">lastSync</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[],</span>
<span class="w">          </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">data</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="nx">rowChanges</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">change</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">sheetId</span><span class="o">:</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">sheetId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">row</span><span class="o">:</span><span class="w"> </span><span class="nx">change</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span>
<span class="w">            </span><span class="nx">column</span><span class="o">:</span><span class="w"> </span><span class="nx">change</span><span class="p">.</span><span class="nx">column</span><span class="p">,</span>
<span class="w">            </span><span class="nx">oldValue</span><span class="o">:</span><span class="w"> </span><span class="nx">change</span><span class="p">.</span><span class="nx">oldValue</span><span class="p">,</span>
<span class="w">            </span><span class="nx">newValue</span><span class="o">:</span><span class="w"> </span><span class="nx">change</span><span class="p">.</span><span class="nx">newValue</span><span class="p">,</span>
<span class="w">            </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">,</span>
<span class="w">            </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">version</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">changes</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 检测冲突</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">detectConflicts</span><span class="p">(</span><span class="nx">changes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">conflicts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grouped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">groupChangesByCell</span><span class="p">(</span><span class="nx">changes</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">grouped</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cellKey</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">cellChanges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grouped</span><span class="p">[</span><span class="nx">cellKey</span><span class="p">];</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cellChanges</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 多个表格修改了同一单元格</span>
<span class="w">        </span><span class="nx">conflicts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">cell</span><span class="o">:</span><span class="w"> </span><span class="nx">cellKey</span><span class="p">,</span>
<span class="w">          </span><span class="nx">changes</span><span class="o">:</span><span class="w"> </span><span class="nx">cellChanges</span><span class="p">,</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">classifyConflict</span><span class="p">(</span><span class="nx">cellChanges</span><span class="p">)</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">conflicts</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 解决冲突</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">resolveConflicts</span><span class="p">(</span><span class="nx">conflicts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">resolved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="nx">conflicts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">conflict</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">winner</span><span class="p">;</span>

<span class="w">      </span><span class="k">switch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">conflictStrategy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;last-write-wins&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// 选择时间戳最新的</span>
<span class="w">          </span><span class="nx">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">conflict</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">            </span><span class="nx">a</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">b</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;highest-version&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// 选择版本号最高的</span>
<span class="w">          </span><span class="nx">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">conflict</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">            </span><span class="nx">a</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">b</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;merge&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// 尝试合并（适用于可合并的数据类型）</span>
<span class="w">          </span><span class="nx">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mergeChanges</span><span class="p">(</span><span class="nx">conflict</span><span class="p">.</span><span class="nx">changes</span><span class="p">);</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;manual&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// 需要人工介入</span>
<span class="w">          </span><span class="nx">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">promptUserResolution</span><span class="p">(</span><span class="nx">conflict</span><span class="p">);</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">          </span><span class="nx">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">conflict</span><span class="p">.</span><span class="nx">changes</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">resolved</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="p">...</span><span class="nx">winner</span><span class="p">,</span>
<span class="w">        </span><span class="nx">conflictResolved</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">conflictType</span><span class="o">:</span><span class="w"> </span><span class="nx">conflict</span><span class="p">.</span><span class="nx">type</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">resolved</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 应用变更到所有表格</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">applyChanges</span><span class="p">(</span><span class="nx">changes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 按表格分组变更</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">changesBySheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">groupBySheet</span><span class="p">(</span><span class="nx">changes</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">sheets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">sheet</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">sheetChanges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">changesBySheet</span><span class="p">[</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sheetChanges</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">openById</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ss</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 批量应用变更</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">prepareBatchUpdate</span><span class="p">(</span><span class="nx">sheetChanges</span><span class="p">);</span>
<span class="w">        </span><span class="nx">ws</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">range</span><span class="p">).</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">batch</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 更新版本号</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">incrementVersion</span><span class="p">(</span><span class="nx">ws</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 元数据管理</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getMetadata</span><span class="p">(</span><span class="nx">sheet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">metaRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;Metadata!A1:B10&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">metaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">metaRange</span><span class="p">.</span><span class="nx">getValues</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">lastModified</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">metaData</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">1</span><span class="p">]),</span>
<span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">metaData</span><span class="p">[</span><span class="mf">1</span><span class="p">][</span><span class="mf">1</span><span class="p">]),</span>
<span class="w">      </span><span class="nx">lastSyncId</span><span class="o">:</span><span class="w"> </span><span class="nx">metaData</span><span class="p">[</span><span class="mf">2</span><span class="p">][</span><span class="mf">1</span><span class="p">],</span>
<span class="w">      </span><span class="nx">checksum</span><span class="o">:</span><span class="w"> </span><span class="nx">metaData</span><span class="p">[</span><span class="mf">3</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">updateMetadata</span><span class="p">(</span><span class="nx">syncId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">sheets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">sheet</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">openById</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ss</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s1">&#39;Metadata&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;B1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">());</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">syncId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;B4&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">calculateChecksum</span><span class="p">(</span>
<span class="w">        </span><span class="nx">ss</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">range</span><span class="p">).</span><span class="nx">getValues</span><span class="p">()</span>
<span class="w">      </span><span class="p">));</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 计算数据校验和</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">calculateChecksum</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="kr">char</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">      </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">hash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">hash</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kr">char</span><span class="p">;</span>
<span class="w">      </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">hash</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">hash</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 监控面板数据</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getSyncStatus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">lastSync</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getLastSyncTime</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">pendingChanges</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">countPendingChanges</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">conflictCount</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getUnresolvedConflicts</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">syncHistory</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">syncLog</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">10</span><span class="p">),</span>
<span class="w">      </span><span class="nx">sheetStatus</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">sheets</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">sheet</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastModified</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getSheetLastModified</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span>
<span class="w">        </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getSheetVersion</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span>
<span class="w">        </span><span class="nx">inSync</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">isSheetInSync</span><span class="p">(</span><span class="nx">sheet</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">      </span><span class="p">}))</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 使用配置</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">syncConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sheets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;sheet1_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;A1:E100&#39;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;sheet2_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;A1:E100&#39;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;sheet3_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">range</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;A1:E100&#39;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">columns</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="p">],</span><span class="w">  </span><span class="c1">// 只同步这些列</span>
<span class="w">  </span><span class="nx">conflictStrategy</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;last-write-wins&#39;</span>
<span class="p">};</span>

<span class="c1">// 创建同步实例</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">syncer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CrossSheetSync</span><span class="p">(</span><span class="nx">syncConfig</span><span class="p">);</span>

<span class="c1">// 设置定时同步</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">setupAutoSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s1">&#39;performSync&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">everyMinutes</span><span class="p">(</span><span class="mf">5</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 执行同步</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">performSync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">syncer</span><span class="p">.</span><span class="nx">performSync</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`同步成功: </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">changesApplied</span><span class="si">}</span><span class="sb"> 个变更`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`同步失败: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 发送告警</span>
<span class="w">    </span><span class="nx">sendAlert</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>这个方案实现了：</p>
<ol>
<li>基于版本向量的冲突检测</li>
<li>多种冲突解决策略</li>
<li>批量变更应用以提高性能</li>
<li>完整的同步状态监控</li>
<li>选择性列同步支持</li>
<li>回滚机制保证数据安全</li>
</ol>
</details>
<p><strong>练习7.7：实现脚本性能监控系统</strong>
设计一个全面的脚本性能监控系统，能够：</p>
<ol>
<li>自动收集执行时间、API调用次数等指标</li>
<li>识别性能瓶颈</li>
<li>生成性能报告</li>
<li>提供优化建议</li>
</ol>
<details>
<summary>提示</summary>
<p>考虑使用装饰器模式和执行时间分析</p>
</details>
<details>
<summary>答案</summary>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>

<span class="cm"> * 脚本性能监控系统</span>
<span class="cm"> */</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PerformanceMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executions</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">apiCalls</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">errors</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">memoryUsage</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">thresholds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="mf">3000</span><span class="p">,</span><span class="w">  </span><span class="c1">// 3秒</span>
<span class="w">      </span><span class="nx">apiCallsPerExecution</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorRate</span><span class="o">:</span><span class="w"> </span><span class="mf">0.05</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 监控装饰器</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">monitor</span><span class="p">(</span><span class="nx">targetFunction</span><span class="p">,</span><span class="w"> </span><span class="nx">functionName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">function</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">execution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">functionName</span><span class="o">:</span><span class="w"> </span><span class="nx">functionName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">targetFunction</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">apiCalls</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">        </span><span class="nx">errors</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// 拦截API调用</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalAPIs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">interceptAPIs</span><span class="p">(</span><span class="nx">execution</span><span class="p">);</span>

<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 执行目标函数</span>
<span class="w">        </span><span class="nx">execution</span><span class="p">.</span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">targetFunction</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">execution</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">          </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span>
<span class="w">          </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 恢复原始API</span>
<span class="w">        </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">restoreAPIs</span><span class="p">(</span><span class="nx">originalAPIs</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 记录执行信息</span>
<span class="w">        </span><span class="nx">execution</span><span class="p">.</span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">        </span><span class="nx">execution</span><span class="p">.</span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">execution</span><span class="p">.</span><span class="nx">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">execution</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">        </span><span class="nx">execution</span><span class="p">.</span><span class="nx">memoryUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">estimateMemoryUsage</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 保存指标</span>
<span class="w">        </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">executions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">execution</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 分析性能</span>
<span class="w">        </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">analyzePerformance</span><span class="p">(</span><span class="nx">execution</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">execution</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 拦截API调用以收集指标</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">interceptAPIs</span><span class="p">(</span><span class="nx">execution</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;SpreadsheetApp.getActiveSheet&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActiveSheet</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Sheet.getRange&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Sheet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getRange</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Range.getValues&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getValues</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Range.setValues&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setValues</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">apis</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">apiName</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">original</span><span class="p">[</span><span class="nx">apiName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apis</span><span class="p">[</span><span class="nx">apiName</span><span class="p">];</span>

<span class="w">      </span><span class="c1">// 包装API</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;SpreadsheetApp&#39;</span><span class="w"> </span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="nb">window</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="mf">0</span><span class="p">]].</span><span class="nx">prototype</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span>

<span class="w">      </span><span class="nx">obj</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 记录调用</span>
<span class="w">        </span><span class="nx">execution</span><span class="p">.</span><span class="nx">apiCalls</span><span class="p">[</span><span class="nx">apiName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="nx">execution</span><span class="p">.</span><span class="nx">apiCalls</span><span class="p">[</span><span class="nx">apiName</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 调用原始方法</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">original</span><span class="p">[</span><span class="nx">apiName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">original</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 恢复原始API</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">restoreAPIs</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">original</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">apiName</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;SpreadsheetApp&#39;</span><span class="w"> </span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="nb">window</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="mf">0</span><span class="p">]].</span><span class="nx">prototype</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span>

<span class="w">      </span><span class="nx">obj</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">original</span><span class="p">[</span><span class="nx">apiName</span><span class="p">];</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 分析性能问题</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">analyzePerformance</span><span class="p">(</span><span class="nx">execution</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">issues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// 检查执行时间</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">execution</span><span class="p">.</span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">thresholds</span><span class="p">.</span><span class="nx">executionTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">issues</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SLOW_EXECUTION&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`执行时间 </span><span class="si">${</span><span class="nx">execution</span><span class="p">.</span><span class="nx">duration</span><span class="si">}</span><span class="sb">ms 超过阈值`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;考虑优化算法或使用批量操作&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 检查API调用次数</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalAPICalls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">execution</span><span class="p">.</span><span class="nx">apiCalls</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">totalAPICalls</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">thresholds</span><span class="p">.</span><span class="nx">apiCallsPerExecution</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">issues</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;EXCESSIVE_API_CALLS&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`API调用 </span><span class="si">${</span><span class="nx">totalAPICalls</span><span class="si">}</span><span class="sb"> 次超过阈值`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;使用批量操作减少API调用&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 检查重复调用</span>
<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">execution</span><span class="p">.</span><span class="nx">apiCalls</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">api</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">issues</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;REPEATED_API_CALLS&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">api</span><span class="si">}</span><span class="sb"> 被调用 </span><span class="si">${</span><span class="nx">count</span><span class="si">}</span><span class="sb"> 次`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="sb">`考虑缓存 </span><span class="si">${</span><span class="nx">api</span><span class="si">}</span><span class="sb"> 的结果`</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">execution</span><span class="p">.</span><span class="nx">performanceIssues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">issues</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 如果有严重问题，记录到日志</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issues</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;性能问题检测:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">issues</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 生成性能报告</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">generateReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateSummary</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">topSlowFunctions</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getTopSlowFunctions</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">apiUsageStats</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAPIUsageStats</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">errorAnalysis</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getErrorAnalysis</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateRecommendations</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">trends</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeTrends</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 生成摘要统计</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">generateSummary</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">executions</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">durations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">executions</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">totalExecutions</span><span class="o">:</span><span class="w"> </span><span class="nx">executions</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">avgDuration</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">average</span><span class="p">(</span><span class="nx">durations</span><span class="p">),</span>
<span class="w">      </span><span class="nx">maxDuration</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">durations</span><span class="p">),</span>
<span class="w">      </span><span class="nx">minDuration</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">durations</span><span class="p">),</span>
<span class="w">      </span><span class="nx">p95Duration</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">percentile</span><span class="p">(</span><span class="nx">durations</span><span class="p">,</span><span class="w"> </span><span class="mf">95</span><span class="p">),</span>
<span class="w">      </span><span class="nx">totalErrors</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorRate</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">executions</span><span class="p">.</span><span class="nx">length</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 获取最慢的函数</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getTopSlowFunctions</span><span class="p">(</span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">functionStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">executions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">exec</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">functionStats</span><span class="p">[</span><span class="nx">exec</span><span class="p">.</span><span class="nx">functionName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">functionStats</span><span class="p">[</span><span class="nx">exec</span><span class="p">.</span><span class="nx">functionName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">exec</span><span class="p">.</span><span class="nx">functionName</span><span class="p">,</span>
<span class="w">          </span><span class="nx">executions</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">totalTime</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">avgTime</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">maxTime</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">functionStats</span><span class="p">[</span><span class="nx">exec</span><span class="p">.</span><span class="nx">functionName</span><span class="p">];</span>
<span class="w">      </span><span class="nx">stats</span><span class="p">.</span><span class="nx">executions</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="nx">stats</span><span class="p">.</span><span class="nx">totalTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">exec</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>
<span class="w">      </span><span class="nx">stats</span><span class="p">.</span><span class="nx">avgTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">totalTime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">executions</span><span class="p">;</span>
<span class="w">      </span><span class="nx">stats</span><span class="p">.</span><span class="nx">maxTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">maxTime</span><span class="p">,</span><span class="w"> </span><span class="nx">exec</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">functionStats</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">avgTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">avgTime</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * API使用统计</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getAPIUsageStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">executions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">exec</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">exec</span><span class="p">.</span><span class="nx">apiCalls</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">api</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">api</span><span class="o">:</span><span class="w"> </span><span class="nx">api</span><span class="p">,</span>
<span class="w">            </span><span class="nx">totalCalls</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="nx">avgCallsPerExecution</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="nx">executions</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">          </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">].</span><span class="nx">totalCalls</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">count</span><span class="p">;</span>
<span class="w">        </span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">].</span><span class="nx">executions</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">].</span><span class="nx">avgCallsPerExecution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">          </span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">].</span><span class="nx">totalCalls</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">apiStats</span><span class="p">[</span><span class="nx">api</span><span class="p">].</span><span class="nx">executions</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">apiStats</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">totalCalls</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">totalCalls</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 生成优化建议</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">generateRecommendations</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateSummary</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAPIUsageStats</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 基于统计生成建议</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">p95Duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PERFORMANCE&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;考虑将长时间运行的任务分解为多个小任务&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;可减少50%以上的执行时间&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 检查高频API调用</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">highFreqAPIs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiStats</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="nx">a</span><span class="p">.</span><span class="nx">avgCallsPerExecution</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">20</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">highFreqAPIs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;API_USAGE&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="sb">`优化以下高频API调用: </span><span class="si">${</span>
<span class="w">          </span><span class="nx">highFreqAPIs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">api</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="w">        </span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;可减少80%的API调用&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 错误率建议</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">errorRate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">thresholds</span><span class="p">.</span><span class="nx">errorRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;RELIABILITY&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;添加更多错误处理和重试机制&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;提高系统可靠性&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 趋势分析</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">analyzeTrends</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recentExecutions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">executions</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">100</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">windows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">slidingWindow</span><span class="p">(</span><span class="nx">recentExecutions</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">performanceTrend</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateTrend</span><span class="p">(</span>
<span class="w">        </span><span class="nx">windows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">average</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">duration</span><span class="p">)))</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="nx">errorTrend</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateTrend</span><span class="p">(</span>
<span class="w">        </span><span class="nx">windows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="nx">apiCallTrend</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateTrend</span><span class="p">(</span>
<span class="w">        </span><span class="nx">windows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">average</span><span class="p">(</span>
<span class="w">          </span><span class="nx">w</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">apiCalls</span><span class="p">).</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">))</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 辅助函数</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">average</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">percentile</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">arr</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sorted</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">slidingWindow</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">windows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">size</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">windows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">windows</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateTrend</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;stable&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">values</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">values</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">avgFirst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">average</span><span class="p">(</span><span class="nx">first</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">avgSecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">average</span><span class="p">(</span><span class="nx">second</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">avgSecond</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">avgFirst</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">avgFirst</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">change</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;increasing&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">change</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="mf">0.1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;decreasing&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;stable&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>

<span class="cm">   * 估算内存使用</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">estimateMemoryUsage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 简化的内存估算</span>
<span class="w">    </span><span class="c1">// 实际实现需要更复杂的方法</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000</span><span class="p">;</span><span class="w">  </span><span class="c1">// 字节</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 使用示例</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PerformanceMonitor</span><span class="p">();</span>

<span class="c1">// 包装函数以监控性能</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">monitoredFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">monitor</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="nx">processData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActiveSheet</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1:Z1000&#39;</span><span class="p">).</span><span class="nx">getValues</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 处理数据...</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 模拟处理</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;AA1:AA1000&#39;</span><span class="p">).</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
<span class="p">},</span><span class="w"> </span><span class="s1">&#39;processData&#39;</span><span class="p">);</span>

<span class="c1">// 生成报告</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">generatePerformanceReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">monitor</span><span class="p">.</span><span class="nx">generateReport</span><span class="p">();</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;性能报告:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;摘要:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">report</span><span class="p">.</span><span class="nx">summary</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;最慢函数:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">report</span><span class="p">.</span><span class="nx">topSlowFunctions</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;优化建议:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">report</span><span class="p">.</span><span class="nx">recommendations</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;趋势分析:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">report</span><span class="p">.</span><span class="nx">trends</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 保存到表格</span>
<span class="w">  </span><span class="nx">saveReportToSheet</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>这个监控系统提供了：</p>
<ol>
<li>自动的性能指标收集</li>
<li>API调用拦截和统计</li>
<li>性能问题自动识别</li>
<li>详细的性能报告生成</li>
<li>趋势分析和预测</li>
<li>可操作的优化建议</li>
</ol>
</details>
<h2 id="_7">常见陷阱与错误</h2>
<h3 id="1">陷阱1：忽视执行时限</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：可能超时的代码</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">processAllRows</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getDataRange</span><span class="p">().</span><span class="nx">getValues</span><span class="p">();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">complexProcessing</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span><span class="w">  </span><span class="c1">// 每行需要1秒</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 正确：分批处理</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">processBatch</span><span class="p">(</span><span class="nx">startRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">startRow</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">batchSize</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">).</span><span class="nx">getValues</span><span class="p">();</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">complexProcessing</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">batchSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 设置触发器处理下一批</span>
<span class="w">    </span><span class="nx">scheduleContinuation</span><span class="p">(</span><span class="nx">startRow</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">batchSize</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2">陷阱2：过度使用全局变量</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：依赖全局状态</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// 每次执行会重置</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">incrementCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span><span class="w">  </span><span class="c1">// 不会持久化</span>
<span class="p">}</span>

<span class="c1">// 正确：使用属性服务</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">incrementCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PropertiesService</span><span class="p">.</span><span class="nx">getScriptProperties</span><span class="p">();</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="nx">props</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">counter</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3">陷阱3：同步思维处理异步问题</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：假设操作立即完成</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">updateAndRead</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="s1">&#39;新值&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span><span class="w">  </span><span class="c1">// 可能还是旧值</span>
<span class="p">}</span>

<span class="c1">// 正确：使用flush确保同步</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">updateAndRead</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="s1">&#39;新值&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span><span class="w">  </span><span class="c1">// 强制应用更改</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4">陷阱4：权限理解错误</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：简单触发器中使用需授权的服务</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onEdit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">MailApp</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">(...);</span><span class="w">  </span><span class="c1">// 会失败</span>
<span class="p">}</span>

<span class="c1">// 正确：使用可安装触发器</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">installableOnEdit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">MailApp</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">(...);</span><span class="w">  </span><span class="c1">// 可以工作</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5">陷阱5：循环触发器</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：onChange触发器修改数据导致再次触发</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onChange</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">());</span><span class="w">  </span><span class="c1">// 触发新的onChange</span>
<span class="p">}</span>

<span class="c1">// 正确：使用标记避免循环</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onChange</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;Z1&#39;</span><span class="p">).</span><span class="nx">getValue</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flag</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;Z1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">());</span>
<span class="w">  </span><span class="nx">sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="s1">&#39;Z1&#39;</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<p>通过本章的学习，您已经掌握了电子表格脚本化和自动化编程的核心技术。这些知识将帮助您构建更强大、更智能的表格应用，充分发挥现代协作平台的潜力。下一章，我们将探讨可视化与仪表板的设计原理。</p>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">← 第6章：数据连接与集成</a><a href="chapter8.html" class="nav-link next">第8章：可视化与仪表板 →</a></nav>
        </main>
    </div>
</body>
</html>